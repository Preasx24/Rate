name: Update Gist Rate Stats

on:
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    env:
      GIST_ID: baaadec8c55a20705b958950ae630b9f
      GIST_FILENAME: rate.json
      TOKENS_URL: https://gist.githubusercontent.com/Preasx24/137f29d4b3b32c251bf6b7ab2b3fae28/raw/gistfile1.txt
      OLD_DATA_RAW_URL: https://gist.githubusercontent.com/Preasx24/baaadec8c55a20705b958950ae630b9f/raw/e3395dee3d0e94f0dfcfcda01503f7ff2c9f88bf/gistfile1.txt

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Download token
        run: |
          TOKEN=$(curl -s $TOKENS_URL | head -n 1)
          echo "GITHUB_TOKEN=$TOKEN" >> $GITHUB_ENV

      - name: Download old data
        run: |
          echo "Downloading old_data.json from $OLD_DATA_RAW_URL"
          set +e
          curl -s $OLD_DATA_RAW_URL -o old_data.json
          CURL_EXIT=$?
          set -e

          if [ $CURL_EXIT -ne 0 ]; then
            echo "⚠️ curl exited with $CURL_EXIT"
            echo "[]" > old_data.json
          fi

          if [ ! -s old_data.json ]; then
            echo "old_data.json empty, initializing with []"
            echo "[]" > old_data.json
          else
            echo "old_data.json downloaded successfully:"
            head -c 200 old_data.json
          fi

      - name: Create new data entry
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "[{\"time\": \"$TIMESTAMP\", \"status\": \"OK\"}]" > new_entries.json

      - name: Merge with old data
        run: |
          jq -s '.[0] + .[1]' old_data.json new_entries.json > combined.json

      - name: Upload to Gist
        run: |
          UPDATE_PAYLOAD=$(jq -n --arg filename "$GIST_FILENAME" --arg content "$(cat combined.json)" \
            '{files: {($filename): {content: $content}}}')

          curl -s -X PATCH \
            -H "Authorization: token $GITHUB_TOKEN" \
            -d "$UPDATE_PAYLOAD" \
            https://api.github.com/gists/$GIST_ID