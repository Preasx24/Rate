name: GitHub Token Rate Tracker

on:
  schedule:
    - cron: "*/2 * * * *"  # Every 2 minutes (minimum GitHub Actions supports)
  workflow_dispatch:

jobs:
  track-rate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (not strictly needed)
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get install jq

      - name: Fetch Token List from Shared Gist
        run: |
          curl -s https://gist.githubusercontent.com/Preasx24/465a9bcaff40443a4c6b0572b7d5e99c/raw/8afd7e8edf7eb498f884134de6a891c644b3c61e/gistfile1.txt > tokens.txt
          cat tokens.txt

      - name: Generate New Rate Info
        run: |
          echo "[" > new_entries.json
          FIRST=true
          while read -r TOKEN; do
            [[ -z "$TOKEN" ]] && continue
            RESP=$(curl -s -H "Authorization: token $TOKEN" https://api.github.com/rate_limit)
            REMAINING=$(echo "$RESP" | jq '.rate.remaining')
            LIMIT=$(echo "$RESP" | jq '.rate.limit')
            RESET=$(echo "$RESP" | jq '.rate.reset')
            TIME=$(date -u -d @"$RESET" '+%Y-%m-%d %H:%M:%S')
            NOW=$(date -u '+%Y-%m-%d %H:%M:%S')
            ENTRY="{\"time_checked\": \"$NOW\", \"token\": \"${TOKEN:0:10}...\", \"remaining\": $REMAINING, \"limit\": $LIMIT, \"reset\": \"$TIME\"}"

            if [ "$FIRST" = true ]; then
              echo "  $ENTRY" >> new_entries.json
              FIRST=false
            else
              echo "  ,$ENTRY" >> new_entries.json
            fi
          done < tokens.txt
          echo "]" >> new_entries.json

      - name: Fetch Existing Gist Data (rate.json)
        run: |
          curl -s -H "Accept: application/vnd.github+json" \
            https://gist.githubusercontent.com/Preasx24/465a9bcaff40443a4c6b0572b7d5e99c/raw/rate.json \
            -o old_data.json

      - name: Combine Old + New JSON
        run: |
          jq -s '.[0] + .[1]' old_data.json new_entries.json > combined.json

      - name: Update Gist with Combined Data
        env:
          GIST_ID: b3ad84ac92321f595b33d4b350938ffa   # Gist to update
        run: |
          MAIN_TOKEN=$(head -n 1 tokens.txt)
          curl -X PATCH \
            -H "Authorization: token $MAIN_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/gists/$GIST_ID \
            -d @- <<EOF
          {
            "files": {
              "rate.json": {
                "content": $(jq -Rs '.' combined.json)
              }
            }
          }
EOF